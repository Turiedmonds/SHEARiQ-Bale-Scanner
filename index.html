
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<title>
  <span style="font-style: italic;">SHEΔR</span>
  <span style="display: inline-block; border: 2px solid #fff; padding: 0 6px; border-radius: 4px; font-weight: bold; font-style: italic; margin-left: 4px;">iQ</span>
  Bale Scanner
</title>

</script>
<style>
    body {
        font-family: 'Arial', sans-serif;
        background-color: #000;
        color: #fff;
        margin: 0;
        padding: 1rem;
    }
    h1 {
        font-size: 1.8rem;
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
        color: #fff;
    }
    .top-right {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 0.5rem;
    }
    .top-right button {
        font-size: 1rem;
        padding: 0.3rem 0.6rem;
        border-radius: 6px;
        background-color: #111;
        color: #fff;
        border: 1px solid #444;
    }
    label {
        display: block;
        font-size: 1.1rem;
        margin: 0.6rem 0 0.3rem 0;
    }
    input {
        font-size: 1rem;
        width: 90%;
        max-width: 400px;
        padding: 0.3rem;
        margin-bottom: 0.8rem;
        border-radius: 5px;
        border: none;
        height: 28px;
        text-align: center;
    }
    button {
        font-size: 1rem;
        padding: 0.4rem 0.8rem;
        margin: 0.3rem;
        border-radius: 6px;
        border: none;
        background-color: #111;
        color: #fff;
    }
    #scanBox {
        margin: 1.2rem auto;
        width: 95%;
        max-width: 400px;
        height: 240px;
        border: 2px solid #fff;
        border-radius: 10px;
        position: relative;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1.5rem;
    }
    th, td {
        border: 1px solid #fff;
        padding: 0.5rem;
        font-size: 1rem;
    }
    body {
        font-family: 'Arial', sans-serif;
        background-color: #000;
        color: #fff;
        margin: 0;
        padding: 1rem;
    }
    h1 {
        font-size: 1.8rem;
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .top-right {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 0.5rem;
    }
    .top-right button {
        font-size: 1rem;
        padding: 0.3rem 0.6rem;
        border-radius: 6px;
    }
    label {
        display: block;
        font-size: 1.1rem;
        margin: 0.6rem 0 0.3rem 0;
    }
    input {
        text-align: center;
        font-size: 1rem;
        width: 90%;
        max-width: 400px;
        padding: 0.3rem;
        margin-bottom: 0.8rem;
        border-radius: 5px;
        border: none;
        height: 28px;
    }
    button {
        font-size: 1rem;
        padding: 0.4rem 0.8rem;
        margin: 0.3rem;
        border-radius: 6px;
        border: none;
        background-color: #222;
        color: #fff;
    }
    #scanBox {
        margin: 1.2rem auto;
        width: 95%;
        max-width: 400px;
        height: 240px;
        border: 2px solid #fff;
        border-radius: 10px;
        position: relative;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1.5rem;
    }
    th, td {
        border: 1px solid #fff;
        padding: 0.5rem;
        font-size: 1rem;
    }
    body {
        font-family: 'Arial', sans-serif;
        background-color: #000;
        color: #fff;
        margin: 0;
        padding: 1rem;
    }
    h1 {
        font-size: 1.8rem;
        margin-top: 0.5rem;
        margin-bottom: 1rem;
    }
    label {
        display: block;
        font-size: 1.1rem;
        margin: 1rem 0 0.4rem 0;
    }
    input {
        text-align: center;
        font-size: 1.1rem;
        width: 90%;
        max-width: 400px;
        padding: 0.4rem;
        margin-bottom: 1rem;
        border-radius: 6px;
        border: none;
        height: 36px;
    }
    button {
        font-size: 1.1rem;
        padding: 0.4rem 0.8rem;
        margin: 0.3rem;
        border-radius: 6px;
        border: none;
        background-color: #222;
        color: #fff;
    }
    .top-right {
        position: relative;
        display: flex;
        justify-content: flex-end;
        margin-bottom: 1rem;
    }
    #scanBox {
        margin: 1.5rem auto;
        width: 95%;
        max-width: 400px;
        height: 240px;
        border: 2px solid #fff;
        border-radius: 10px;
        position: relative;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 2rem;
    }
    th, td {
        border: 1px solid #fff;
        padding: 0.6rem;
        font-size: 1rem;
    }
    body {
        font-family: 'Arial', sans-serif;
        background-color: #000;
        color: #fff;
        margin: 0;
        padding: 1rem;
    }
    h1 {
        font-size: 2rem;
        margin-top: 1rem;
        margin-bottom: 1rem;
    }
    label {
        display: block;
        font-size: 1.2rem;
        margin: 1rem 0 0.2rem 0;
    }
    input {
        text-align: center;
        font-size: 1.2rem;
        width: 90%;
        max-width: 400px;
        padding: 0.5rem;
        margin-bottom: 1rem;
        border-radius: 8px;
        border: none;
    }
    button {
        font-size: 1.2rem;
        padding: 0.6rem 1rem;
        margin: 0.3rem;
        border-radius: 8px;
        border: none;
        background-color: #222;
        color: #fff;
    }
    .top-right {
        position: fixed;
        top: 1rem;
        right: 1rem;
    }
    #scanBox {
        margin: 1.5rem auto;
        width: 95%;
        max-width: 400px;
        height: 240px;
        border: 2px solid #fff;
        border-radius: 10px;
        position: relative;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 2rem;
    }
    th, td {
        border: 1px solid #fff;
        padding: 0.6rem;
        font-size: 1rem;
    }
    body { font-family: Arial, sans-serif; background: #000; color: #fff; text-align: center; padding: 10px; }
    input, button { font-size: 16px; margin: 5px; padding: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #fff; padding: 5px; font-size: 14px; }
    #scanBox { margin: 10px auto; width: 320px; height: 240px; border: 2px solid #fff; position: relative; }
    #startScanBtn { position: absolute; bottom: 5px; left: 5px; z-index: 5; }
  .new-day-button {
  font-size: 1rem;
  padding: 0.3rem 0.6rem;
  border-radius: 6px;
  background-color: #111;
  color: #fff;
  border: 1px solid #444;
  margin-left: 1rem;
}
</style>
<link href="manifest.json" rel="manifest"/><meta content="#FFD700" name="theme-color"/></head>
<body>
<img alt="SHEΔR iQ Logo" src="..." style="display: block; margin: 0 auto 0.5rem auto;" />
<div class="scanner-header">
<h1 style="margin: 0.2rem 0 0 0; font-size: 1.8rem; text-align: center;">Bale Scanner</h1> 
</div>
<div style="text-align: right; margin-top: 0.3rem;">
  <button class="new-day-button" onclick="location.reload()">New Day</button>
</div>
<div style="position: absolute; top: 10px; right: 10px;">
<button onclick="resetAllFarms()">Reset All</button>
</div>
<label>Farm/Station Name: <input id="station" type="text"/></label><br/>
<label>Wool Presser: <input id="presser" type="text"/></label><br/>
<label>Start Bale Number: <input id="startBale" type="number" value="1"/></label>
<button onclick="setStartingBale()">Set Start Number</button>
<button onclick="resetThisFarmSession()">Reset This Farm Only</button>
<p id="currentBaleDisplay">Current Bale: 0</p>
<p id="lastBaleNumberDisplay">Last Bale #: 0</p>
<p id="todayCountDisplay">Today's Bale Count: 0</p>
<div id="scanBox">
<button id="startScanBtn" onclick="startQRScan()">Start QR Scan</button>
</div>
<button onclick="deleteLastEntry()">Delete Last Entry</button>
<button onclick="exportCSV()">Export CSV</button>
<table id="logTable">
<thead>
<tr><th>#</th><th>Wool Type</th><th>Presser</th><th>Farm</th><th>Timestamp</th></tr>
</thead>
<tbody></tbody>
</table>
<!-- Wool Type Totals Table -->
<h2 style="margin-top: 30px;">Wool Type Totals</h2>
<table border="1" id="woolTypeTotals" style="width: 100%; margin-bottom: 20px;">
<thead>
<tr>
<th>Wool Type</th>
<th>Total Bales</th>
</tr>
</thead>
<tbody>
<!-- Totals will be inserted here dynamically -->
</tbody>
</table>
<script>
let baleCount = 0;
let sessionCount = 0;
let baleCountSet = false;
let videoStream = null;
let animationFrameId = null;

function getStoredBaleCount(farmName) {
  const key = "lastBale_" + farmName.toLowerCase();
  const stored = localStorage.getItem(key);
  return stored ? parseInt(stored) + 1 : null;
}

function storeBaleCount(farmName, count) {
  const key = "lastBale_" + farmName.toLowerCase();
  localStorage.setItem(key, count);
}

function setStartingBale() {
  const farmName = document.getElementById("station").value.trim();
  if (farmName) {
    const stored = getStoredBaleCount(farmName);
    if (stored !== null) {
      document.getElementById("startBale").value = stored;
    }
  }

  const start = parseInt(document.getElementById("startBale").value);
  if (!isNaN(start)) {
    baleCount = start;
    sessionCount = 0;
    baleCountSet = true;
    updateDisplays();
  }
}

function resetThisFarmSession() {
  const farmNameInput = document.getElementById("station").value.trim();
  if (!farmNameInput) {
    alert("Please enter a farm name to reset.");
    return;
  }

  const key = "lastBale_" + farmNameInput.toLowerCase();
  localStorage.removeItem(key);

  baleCount = 0;
  sessionCount = 0;
  baleCountSet = false;
  updateDisplays();

  alert(`Reset complete for "${farmNameInput}". All bale data cleared for this farm.`);
}

function updateDisplays() {
  document.getElementById("currentBaleDisplay").textContent = "Current Bale: " + baleCount;
  document.getElementById("lastBaleNumberDisplay").textContent = "Last Bale #: " + (baleCount > 0 ? baleCount - 1 : 0);
  document.getElementById("todayCountDisplay").textContent = "Today's Bale Count: " + sessionCount;
}

function logBale(qrText) {
  playFeedback();
  const table = document.getElementById("logTable").querySelector("tbody");
  const row = table.insertRow();
  row.insertCell(0).textContent = baleCount;
  row.insertCell(1).textContent = qrText;
  row.insertCell(2).textContent = document.getElementById("presser").value;
  row.insertCell(3).textContent = document.getElementById("station").value;
  row.insertCell(4).textContent = new Date().toLocaleString();
  sessionCount++;
  storeBaleCount(document.getElementById("station").value.trim(), baleCount);
  baleCount++;
  updateDisplays();
  updateWoolTypeTotals(qrText.trim());
}

function startQRScan() {
  if (!baleCountSet) {
    alert("Please set a starting bale number first.");
    return;
  }

  const scanBox = document.getElementById("scanBox");
  scanBox.innerHTML = '<video id="preview" style="width:100%; height:100%;" autoplay muted playsinline></video>' +
                      '<button id="startScanBtn" onclick="startQRScan()">Start QR Scan</button>';
  const video = document.getElementById("preview");
  const canvasElement = document.createElement("canvas");
  const canvas = canvasElement.getContext("2d");

  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(function(stream) {
      videoStream = stream;
      video.srcObject = stream;
      requestAnimationFrame(tick);
    })
    .catch(function(err) {
      alert("Camera error: " + err.message);
    });

  function tick() {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      canvasElement.height = video.videoHeight;
      canvasElement.width = video.videoWidth;
      canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
      const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);
      if (code) {
        logBale(code.data);
        stopQRScan();
        return;
      }
    }
    animationFrameId = requestAnimationFrame(tick);
  }
}

function stopQRScan() {
  if (videoStream) {
    videoStream.getTracks().forEach(track => track.stop());
    videoStream = null;
  }
  if (animationFrameId) {
    cancelAnimationFrame(animationFrameId);
    animationFrameId = null;
  }
  document.getElementById("scanBox").innerHTML = '<button id="startScanBtn" onclick="startQRScan()">Start QR Scan</button>';
}

function deleteLastEntry() {

  const logTable = document.getElementById("logTable").querySelector("tbody");
  const lastRow = logTable.rows[logTable.rows.length - 1];
  const woolType = lastRow.cells[1].textContent.trim();
  const totalsTable = document.getElementById("woolTypeTotals").querySelector("tbody");
  for (let i = 0; i < totalsTable.rows.length; i++) {
    let row = totalsTable.rows[i];
    if (row.cells[0].textContent.trim() === woolType) {
      let count = parseInt(row.cells[1].textContent);
      if (count > 1) {
        row.cells[1].textContent = count - 1;
      } else {
        totalsTable.deleteRow(i);
      }
      break;
    }
  }
  logTable.removeChild(lastRow);
  sessionCount = Math.max(0, sessionCount - 1);
  baleCount = Math.max(0, baleCount - 1);
  storeBaleCount(document.getElementById("station").value.trim(), baleCount);
  updateDisplays();

}

function exportCSV() {
  const rows = [["#", "Wool Type", "Presser", "Farm", "Timestamp"]];
  const table = document.getElementById("logTable").querySelector("tbody");
  for (let row of table.rows) {
    let cells = Array.from(row.cells).map(cell => cell.textContent);
    rows.push(cells);
  }
  const csvContent = rows.map(e => e.join(",")).join("\n");
  const blob = new Blob([csvContent], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.setAttribute("href", url);
  a.setAttribute("download", "bale_log.csv");
  a.click();
}

function resetAllFarms() {
  const keysToRemove = [];
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key && key.startsWith("lastBale_")) {
      keysToRemove.push(key);
    }
  }

  keysToRemove.forEach(key => localStorage.removeItem(key));

  baleCount = 0;
  sessionCount = 0;
  baleCountSet = false;
  updateDisplays();

  alert("All farm bale counts have been reset.");
}

</script>
<audio id="beepSound" preload="auto">
<source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" type="audio/ogg"/>
</audio>
<script>
function playFeedback() {
  const beep = document.getElementById("beepSound");
  if (beep) beep.play();
  if (navigator.vibrate) navigator.vibrate([50, 100, 50]);
}

// === Wool Type Totals Tracking ===
function updateWoolTypeTotals(woolType) {
  const totalsTable = document.getElementById("woolTypeTotals").getElementsByTagName("tbody")[0];
  let found = false;

  for (let row of totalsTable.rows) {
    let typeCell = row.cells[0];
    let countCell = row.cells[1];
    if (typeCell.textContent === woolType) {
      countCell.textContent = parseInt(countCell.textContent) + 1;
      found = true;
      break;
    }
  }

  if (!found) {
    let newRow = totalsTable.insertRow();
    let woolTypeCell = newRow.insertCell(0);
    let countCell = newRow.insertCell(1);
    woolTypeCell.textContent = woolType;
    countCell.textContent = "1";
  }
}

</script>
    <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js')
        .then(registration => {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        })
        .catch(error => {
          console.log('ServiceWorker registration failed:', error);
        });
    });
  }
</script>
</body>
</html>
